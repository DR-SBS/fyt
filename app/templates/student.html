{% extends "extends/base-user.html" %}

{% block user %} 
    {{ user.username }}
{% endblock %}

{% block profilepic %}
    <img class="image-responsive shadow rounded-circle img-size no-select"
         style="width:200px;height:200px;" src='{{ profilepic }}'/>
{% endblock %}

{% block sidebar_menu %}
    <li id="my-tutors">
        <a href="{{ url_for('student_followed_tutors') }}"><i class="fas fa-chalkboard-teacher"></i>
            My Tutors</a>
    </li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div id="view-profile-link">
        <a href="{{url_for('profile', username=user.username)}}" style="float:right;" class="btn btn-success">View Profile</a>
    </div>
    <div id="recommendation">
        <legend class="border-bottom mb-4"> Tutors for you </legend>
        {% if matching_tutor %}
            <div id="course-recommendation">
                <h6> Based on course </h6>
                <div class="row">
                    {% for tutor in matching_tutor %}

                        <div class="col-md-6">
                            <div class="card">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card-body">
                                            <h5 class="card-title" >
                                                <a href="{{ url_for('profile', username=tutor.User.username)}}">
                                                    {{ tutor.User.tutor.full_name }}
                                                </a>   
                                            </h5>
                                            <p class="card-text">
                                                Phone: {{ tutor.User.tutor.phone }}
                                                <br>
                                                Email: {{ tutor.User.email }}   
                                                <br>                                                
                                                Course:
                                                <br>
                                                {% for tutor_courses in course_by_tutor %}
                                                    {% if tutor.User.id == tutor_courses.User.id%}
                                                        {%for course in tutor.User.mycourse%}
                                                            {% if tutor_courses.Course.course_title==course.Course.course_title %}
                                                                <a href="{{url_for('courses_by_id',id=tutor_courses.Course.id)}}">{{ tutor_courses.Course.course_title}}</a> {{tutor_courses.Mycourse.cost}} {{tutor_courses.Mycourse.time}}
                                                                <br>
                                                            {%endif%}
                                                        {%endfor%}
                                                    {%endif%}
                                                {%endfor%}

                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-md-6" style="margin:auto">
                                        <img src="{{url_for('static',filename='profile_pics/'+tutor.User.tutor.profile_pic)}}" class="img-responsive rounded-circle">
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    
    <div='map-division'>
        {% if user.location.latitude and user.location.longitude %}  
            <div id="map"></div>
        {% else %}
            <div class="button">
                <h3>Please set your location!</h3>
                <div>
                {% if user.role=="tutor" %}
                    <button class="btn btn-info"><a href="{{ url_for('tutor_location') }}">Set Your Location</a></button>
                {% else %}
                    <button class="btn btn-info"><a href="{{ url_for('student_location') }}">Set Your Location</a></button>
                {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block additional_style %}
     #map {
        height: 800px; 
        width: 800px; 
        margin: auto;
        background-color: grey;
        margin-top:20px;
        border-radius: 50%;
    }
{% endblock %}

{% block document_javascript %}
    const icons = {
        tutor: "{{ url_for('static', filename='images/tutor-marker.png') }}",
        student: "{{ url_for('static', filename='images/student-marker.png') }}"
    };

    function initMap() {
        
        var userLocation = {
            lat: parseFloat({{ user.location.latitude }}),
            lng: parseFloat({{ user.location.longitude }})
        };
        
        var map = new google.maps.Map(document.getElementById("map"), {
            zoom: 15,
            center: userLocation,
            gestureHandling: 'none',
            zoomControl: false
        });

        var studentMarker = new google.maps.Marker({
            position: userLocation,
            map: map,
            icon: icons.student,
            title: "{{ user.student.full_name }}"
        });

        google.maps.event.addListener(studentMarker, 'click', ()=> {
            window.open(
                    "{{ url_for('profile', username=user.username) }}",
                    '_blank' 
            );
        })

        {% for tutor in tutor_list %}
            var tutorLocation = {
                lat: parseFloat({{ tutor.location.latitude }}),
                lng: parseFloat({{ tutor.location.longitude }})
            };
            
            var tutorMarker = new google.maps.Marker({
                position: tutorLocation,
                map: map,
                icon: icons.tutor,
                title: "{{ tutor.tutor.full_name }}"
            });

            google.maps.event.addListener(tutorMarker, 'click', ()=> {
                window.open(
                    "{{ url_for('profile', username=tutor.username) }}",
                    '_blank' 
                );
            })
        {% endfor %}
    }
{% endblock %}

{% block additional_script%}
     <script defer
        src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap">
    </script>
{%endblock%}